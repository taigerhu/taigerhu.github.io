<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Kernel CFI failure实例分析 | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kernel CFI failure实例分析</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kernel CFI failure实例分析</h1><div class="post-meta">2024-06-01</div><div class="post-content"><p>最近压测碰到一例内核死机, 提示CFI failure.</p>
<p>先了解下CFI:</p>
<blockquote>
<p>Control-flow integrity (CFI) is a technique used to reduce the ability to redirect the execution of a program’s code in attacker-specified ways. </p>
</blockquote>
<p>字面直译CFI就是控制流完整性，用来减少通过修改代码流程来进行攻击的风险。</p>
<blockquote>
<p>The goal behind CFI is to try to ensure that indirect calls go to the expected addresses and that the return addresses are not changed.</p>
</blockquote>
<p>具体说就是用来保护indirect (function) call这种code flow的.</p>
<blockquote>
<p>Function pointers are used for indirect function calls, which are different than direct function calls because the address of the call site is not stored in the (non-writable) kernel text. Instead, the address for the call site is fetched from memory, placed into a register, and the call is made via that value. If an attacker can change the memory, they can control where the call actually ends up going. That is the “forward edge” of an indirect call, while the return address on the stack is the “backward edge” of the call. Either can be used by an attacker to redirect the code flow.</p>
</blockquote>
<p>这个indirect call就是函数指针了，有两个可攻击的点：一个是forward edge(goto expected address)，一个是backward edge(return address)。</p>
<blockquote>
<p>The writable function pointers can only exist in the kernel’s heap and stack due to the earlier tightening of the access to the rest of memory. Function pointers can be stored in the heap or on the stack. It turns out that making the stack read-only “makes it very hard to use”, Cook said with a chuckle.</p>
</blockquote>
<p>函数指针在kernel heap or stack上, 这些区域都可写，不像direct call那样都在只读区。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>kernel 5.x, crash stack:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ 7322.456761] Kernel panic - not syncing: CFI failure (target: 0x1ffffffff):</span><br><span class="line">[...]</span><br><span class="line">[ 7322.485335] Call trace:</span><br><span class="line">[ 7322.488711]  dump_backtrace.cfi_jt+0x0/0x8</span><br><span class="line">[ 7322.493730]  show_stack+0x28/0x38</span><br><span class="line">[ 7322.497969]  dump_stack_lvl+0x84/0xcc</span><br><span class="line">[ 7322.502560]  panic+0x180/0x444</span><br><span class="line">[ 7322.506537]  __cfi_slowpath_diag+0x1e4/0x230</span><br><span class="line">[ 7322.511733]  dma_buf_unmap_attachment+0x108/0x144</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>objdump定位到<code>dma_buf_unmap_attachment+0x108</code>如下882行：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; drivers/dma-buf/dma-buf.c:882</span><br><span class="line">ffffffc008b973ac: 97df944b      bl      0xffffffc00837c4d8 &lt;__cfi_slowpath_diag&gt;</span><br><span class="line">ffffffc008b973b0: f94003e8      ldr     x8, [sp]</span><br><span class="line">ffffffc008b973b4: f9400fa1      ldr     x1, [x29, #24]</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">875</span> <span class="type">static</span> <span class="type">void</span> __unmap_dma_buf(<span class="keyword">struct</span> dma_buf_attachment *attach,</span><br><span class="line"><span class="number">876</span>                             <span class="keyword">struct</span> sg_table *sg_table,</span><br><span class="line"><span class="number">877</span>                             <span class="keyword">enum</span> dma_data_direction direction)</span><br><span class="line"><span class="number">878</span> &#123;</span><br><span class="line"><span class="number">879</span>         <span class="comment">/* uses XOR, hence this unmangles */</span></span><br><span class="line"><span class="number">880</span>         mangle_sg_table(sg_table);</span><br><span class="line"><span class="number">881</span></span><br><span class="line"><span class="number">882</span>         attach-&gt;dmabuf-&gt;ops-&gt;unmap_dma_buf(attach, sg_table, direction); <span class="comment">//tj: here</span></span><br><span class="line"><span class="number">883</span> &#125;</span><br></pre></td></tr></table></figure>

<p>啊，这是一个indirect function call。这为啥挂了，看下kernel cfi code:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">26</span> <span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">handle_cfi_failure</span><span class="params">(<span class="type">void</span> *ptr)</span></span><br><span class="line">27 &#123;</span><br><span class="line"><span class="number">28</span>         <span class="keyword">if</span> (IS_ENABLED(CONFIG_CFI_PERMISSIVE))</span><br><span class="line"><span class="number">29</span>                 WARN_RATELIMIT(<span class="number">1</span>, <span class="string">&quot;CFI failure (target: %pS):\n&quot;</span>, ptr);</span><br><span class="line"><span class="number">30</span>         <span class="keyword">else</span></span><br><span class="line"><span class="number">31</span>                 panic(<span class="string">&quot;CFI failure (target: %pS)\n&quot;</span>, ptr); <span class="comment">//tj: here</span></span><br><span class="line"><span class="number">32</span> &#125;</span><br></pre></td></tr></table></figure>

<p>这个target 0x1ffffffff是啥？简单跟下：</p>
<p>我们配了MODULES：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __cfi_slowpath_diag(<span class="type">uint64_t</span> id, <span class="type">void</span> *ptr, <span class="type">void</span> *diag)</span><br><span class="line">&#123;</span><br><span class="line">        ___cfi_slowpath_diag(id, ptr, diag);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__cfi_slowpath_diag);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">/* !CONFIG_MODULES */</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __nocfi ___cfi_slowpath_diag(<span class="type">uint64_t</span> id, <span class="type">void</span> *ptr, <span class="type">void</span> *diag)</span><br><span class="line">&#123;</span><br><span class="line">        cfi_check_fn fn = find_check_fn((<span class="type">unsigned</span> <span class="type">long</span>)ptr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (likely(fn))</span><br><span class="line">                fn(id, ptr, diag);</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">/* Don&#x27;t allow unchecked modules */</span></span><br><span class="line">                handle_cfi_failure(ptr); <span class="comment">//tj: here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看上去这个<code>ptr</code>(&#x3D;0x1ffffffff)不是一个function, so走到了unchecked modules分支，rt? 内存出问题了？ 不应该。。。看栈是通过ioctl下来的，所以可能是用户态触发了一个非法请求，暂不论，我们看看如何在内核态规避这个问题。</p>
<blockquote>
<p>To assist in debugging CFI failures, enable CONFIG_CFI_PERMISSIVE, which prints out a warning instead of causing a kernel panic. Permissive mode must not be used in production.</p>
</blockquote>
<p>使能内核配置<code>CONFIG_CFI_PERMISSIVE</code>，不过我试了下竟然起不来。。。什么鬼，没跟了，而且一开全开似乎不妥，有没有单一文件跳过CFI的？答案是有的，CFI提交日志写道：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">commit cf68fffb66d60d96209446bfc4a15291dc5a5d41</span><br><span class="line">Author: Sami Tolvanen &lt;samitolvanen@google.com&gt;</span><br><span class="line">Date:   Thu Apr 8 11:28:26 2021 -0700</span><br><span class="line"></span><br><span class="line">    add support for Clang CFI</span><br><span class="line"></span><br><span class="line">    [...]</span><br><span class="line"></span><br><span class="line">    CFI checking can be disabled in a function with the __nocfi attribute.</span><br><span class="line">    Additionally, CFI can be disabled for an entire compilation unit by</span><br><span class="line">    filtering out CC_FLAGS_CFI.</span><br></pre></td></tr></table></figure>

<p>这个帅啊，可以函数禁用。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">diff --git a/include/linux/compiler-clang.h b/include/linux/compiler-clang.h</span><br><span class="line">index d217c382b02d.<span class="number">.6</span>de9d0c9377e <span class="number">100644</span></span><br><span class="line">--- a/include/linux/compiler-clang.h</span><br><span class="line">+++ b/include/linux/compiler-clang.h</span><br><span class="line">@@ <span class="number">-61</span>,<span class="number">3</span> +<span class="number">61</span>,<span class="number">5</span> @@</span><br><span class="line"> <span class="meta">#<span class="keyword">if</span> __has_feature(shadow_call_stack)</span></span><br><span class="line"> <span class="meta"># <span class="keyword">define</span> __noscs       __attribute__((__no_sanitize__(<span class="string">&quot;shadow-call-stack&quot;</span>)))</span></span><br><span class="line"> <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="keyword">define</span> __nocfi                __attribute__((__no_sanitize__(<span class="string">&quot;cfi&quot;</span>)))</span></span><br></pre></td></tr></table></figure>

<p>注意到没，<code>___cfi_slowpath_diag()</code>就有这个属性。</p>
<p>加上即可：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">875</span> <span class="type">static</span> <span class="type">void</span> __nocfi __unmap_dma_buf(<span class="keyword">struct</span> dma_buf_attachment *attach,</span><br></pre></td></tr></table></figure>

<p>反汇编看了下，确是没了，完美。不过上层的问题不能老让kernel修吧。。。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Control-flow_integrity">https://en.wikipedia.org/wiki/Control-flow_integrity</a></li>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/810077/">https://lwn.net/Articles/810077/</a></li>
<li><a target="_blank" rel="noopener" href="https://outflux.net/slides/2020/lca/cfi.pdf">https://outflux.net/slides/2020/lca/cfi.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://source.android.com/docs/security/test/cfi">https://source.android.com/docs/security/test/cfi</a></li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/cfi"><i class="fa fa-tag">cfi</i></a></div><div class="post-nav"><a class="pre" href="/how-to-xmit-evt-response-to-bt-vendor-lib-in-oh.html">How to transmit evt reponse to BT vendor lib in OH</a><a class="next" href="/linux-kernel-drm-overview.html">Linux kernel DRM overview</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-to-xmit-evt-response-to-bt-vendor-lib-in-oh.html">How to transmit evt reponse to BT vendor lib in OH</a></li><li class="post-list-item"><a class="post-list-link" href="/kernel-cfi-failure-analysis.html">Kernel CFI failure实例分析</a></li><li class="post-list-item"><a class="post-list-link" href="/linux-kernel-drm-overview.html">Linux kernel DRM overview</a></li><li class="post-list-item"><a class="post-list-link" href="/upgrade-my-custom-build-server-amd-based.html">我的PC组装升级记</a></li><li class="post-list-item"><a class="post-list-link" href="/convert-typecho-to-hexo.html">I am back!</a></li><li class="post-list-item"><a class="post-list-link" href="/review-freezing-issue-when-drag-icon-after-ohos-adaption.html">OpenHarmony适配后图标拖拽卡屏问题回顾</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-fix-parse-too-complex-in-source-insight.html">Source Insight 自定义解析</a></li><li class="post-list-item"><a class="post-list-link" href="/adapt-ohos-for-mali-g57-on-sprd-t606.html">转：拥抱鸿蒙 - 在展讯T606平台上的探索与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/essential-inventory-of-adaption-for-unisoc-platform-androidt-based.html">展讯平台 OpenHarmony 3.2.2 适配基础盘点</a></li><li class="post-list-item"><a class="post-list-link" href="/porting-openharmony-linux-kernel-to-3rd-party-chip.html">快速移植 OpenHarmony Linux 内核到三方 ARM64 平台</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">arm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">dd</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ebpf/">ebpf</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">fs</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">iot</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">mm</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">msm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ohos/">ohos</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">stab</a><span class="category-list-count">28</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">20</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>