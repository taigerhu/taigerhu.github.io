<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>System Crash实例分析一 | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">System Crash实例分析一</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">System Crash实例分析一</h1><div class="post-meta">2018-05-08</div><div class="post-content"><p>死机分析以前在R平台搞过，基本就是抓到死机时的CPU register等信息，然后用objdump反汇编出来结合源码定位分析，现在到了手机平台，多了个Tracer32，高通分析死机都在用，现在死机都挂我这了，老问高通也不是个事重拾下，我觉得可以不用trace32，基本还是那老一套。</p>
<p>先来看死机现场:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ 1256.852648] Unable to handle kernel NULL pointer dereference at virtual address 00000004 </span><br><span class="line">[ 1256.931061] pgd = e2110000 </span><br><span class="line">[ 1256.933725] [00000004] *pgd=00000000 </span><br><span class="line">[ 1256.937725] Internal error: Oops: 5 [#1] PREEMPT SMP ARM </span><br><span class="line">[ 1256.942470] Modules linked in: wlan(O) [last unloaded: wlan] </span><br><span class="line">[ 1256.948098] CPU: 1 PID: 585 Comm: qti Tainted: G W O 3.18.71-perf-g24d2c84 #1 </span><br><span class="line">[ 1256.956092] task: e41161c0 ti: e2148000 task.ti: e2148000 </span><br><span class="line">[ 1256.961479] PC is at diagchar_read+0x610/0x11fc </span><br><span class="line">[ 1256.965978] LR is at 0x0 </span><br><span class="line">[ 1256.968488] pc : [&lt;c04e0b24&gt;] lr : [&lt;00000000&gt;] psr: 60010013 </span><br><span class="line">[ 1256.968488] sp : e2149ef0 ip : 00000051 fp : b1bb5b7c </span><br><span class="line">[ 1256.979944] r10: c6651000 r9 : 00000201 r8 : c5227bc0 </span><br><span class="line">[ 1256.985152] r7 : c13dbc38 r6 : 00000014 r5 : 000186a0 r4 : b1bb5b78 </span><br><span class="line">[ 1256.991676] r3 : 00000000 r2 : 80000000 r1 : 00000000 r0 : 00000000 </span><br></pre></td></tr></table></figure>

<p>内核空指针，一个关键信息是pc：c04e0b24。</p>
<p>objdump vmlinux出来后，基本<code>-lD</code>就够用了，搜到pc:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2933</span><br><span class="line">c04e0b1c:	e3510000 	cmp	 r1, #0</span><br><span class="line">c04e0b20:	05983030 	ldreq 	 r3, [r8, #48]	; 0x30</span><br><span class="line">c04e0b24:	05933004 	ldreq	 r3, [r3, #4] ===============&gt; 这里crash</span><br><span class="line">c04e0b28:	0a000028 	beq	 c04e0bd0 &lt;diagchar_read+0x6bc&gt;</span><br><span class="line">c04e0b2c:	ea0001b2 	b	 c04e11fc &lt;diagchar_read+0xce8&gt; </span><br><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2937</span><br></pre></td></tr></table></figure>

<p>找到源码2933行:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">if</span> (driver-&gt;data_ready[index] &amp; EVENT_MASKS_TYPE) &#123;</span><br><span class="line">		<span class="comment">/*Copy the type of data being passed*/</span></span><br><span class="line">		data_type = driver-&gt;data_ready[index] &amp; EVENT_MASKS_TYPE;</span><br><span class="line">		session_info = diag_md_session_get_peripheral(APPS_DATA);</span><br><span class="line">		COPY_USER_SPACE_OR_EXIT(buf, data_type, <span class="number">4</span>);</span><br><span class="line"><span class="number">2931</span>		<span class="keyword">if</span> (session_info &amp;&amp; session_info-&gt;event_mask &amp;&amp;</span><br><span class="line"><span class="number">2932</span>		    session_info-&gt;event_mask-&gt;ptr) &#123;</span><br><span class="line"><span class="number">2933</span>			COPY_USER_SPACE_OR_EXIT(buf + <span class="keyword">sizeof</span>(<span class="type">int</span>),</span><br><span class="line">					*(session_info-&gt;event_mask-&gt;ptr),</span><br><span class="line">					session_info-&gt;event_mask-&gt;mask_len);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			COPY_USER_SPACE_OR_EXIT(buf + <span class="keyword">sizeof</span>(<span class="type">int</span>),</span><br><span class="line">						*(event_mask.ptr),</span><br><span class="line">						event_mask.mask_len);</span><br><span class="line">		&#125;</span><br><span class="line">		driver-&gt;data_ready[index] ^= EVENT_MASKS_TYPE;</span><br><span class="line">		<span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>2933行是：<code>COPY_USER_SPACE_OR_EXIT(buf + sizeof(int),</code>，crash的地方再看下现场：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">r8 : c5227bc0</span><br><span class="line">r3 : 00000000</span><br></pre></td></tr></table></figure>

<p>也就是说r3 &#x3D; 0是触发这个死机的因, r3和r8看着应该和2934，2935有关，那到底是不是了，先看下偏移，struct里又是宏又是嵌套结构体，用gdb帮忙：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ arm-eabi-gdb vmlinux </span><br><span class="line">GNU gdb (GDB) 7.6</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line"></span><br><span class="line">(gdb) p &amp;((struct diag_md_session_t*)0)-&gt;event_mask</span><br><span class="line">$1 = (struct diag_mask_info **) 0x30</span><br><span class="line"></span><br><span class="line">(gdb) p &amp;((struct diag_mask_info*)0)-&gt;mask_len</span><br><span class="line">$2 = (int *) 0x4 &lt;__vectors_start+4&gt;</span><br></pre></td></tr></table></figure>

<p>再往上看看就能得出：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">r8=session_info</span><br><span class="line">r3=r8+48=session_info-&gt;event_mask</span><br><span class="line">r3=r3+4=session_info-&gt;event_mask-&gt;mask_len</span><br></pre></td></tr></table></figure>

<p>r3&#x3D;0触发，也就是session_info-&gt;event_mask是0？2931已经判断过了：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2931 (discriminator 1)</span><br><span class="line">c04e0a68:	e3580000 	cmp	r8, #0 ==================&gt; r8 = sesstion_info</span><br><span class="line">/work/buildfarm/jenkins/workspace/buildfarml_rmnj_10/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2930 (discriminator 1)</span><br><span class="line">c04e0a6c:	e2833004 	add	r3, r3, #4</span><br><span class="line">c04e0a70:	e58d3024 	str	r3, [sp, #36]	; 0x24</span><br><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2931 (discriminator 1)</span><br><span class="line">c04e0a74:	0a00002d 	beq	c04e0b30 &lt;diagchar_read+0x61c&gt;</span><br><span class="line">c04e0a78:	e5982030 	ldr	r2, [r8, #48]	; 0x30 =====&gt; r2 = sesstion_info-&gt;event_mask</span><br><span class="line">c04e0a7c:	e3520000 	cmp	r2, #0 ==============&gt; sesstion_info-&gt;event_mask == 0?</span><br><span class="line">c04e0a80:	0a00002a 	beq	c04e0b30 &lt;diagchar_read+0x61c&gt;</span><br><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2932 (discriminator 1)</span><br><span class="line">c04e0a84:	e592a000 	ldr	sl, [r2]</span><br><span class="line">/code/kernel/msm-3.18/drivers/char/diag/diagchar_core.c:2931 (discriminator 1)</span><br><span class="line">c04e0a88:	e35a0000 	cmp	sl, #0</span><br><span class="line">c04e0a8c:	0a000027 	beq	c04e0b30 &lt;diagchar_read+0x61c&gt;</span><br></pre></td></tr></table></figure>

<p>so, 难道是DDR出现了跳变？多半是硬件问题。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/crash"><i class="fa fa-tag">crash</i></a></div><div class="post-nav"><a class="pre" href="/analyze-lmk-under-android-go.html">Android Go lowmemorykiller分析</a><a class="next" href="/fix-an-issue-about-context_to_sid-returned-12.html">SELinux: fix an issue about context_to_sid returned 12</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-to-use-adeb-to-install-bcc-into-android.html">转: 使用 adeb 在 Android 上编译安装 bcc</a></li><li class="post-list-item"><a class="post-list-link" href="/kworker-sched-la-stat.html">kworker 调度延迟性能测试和统计</a></li><li class="post-list-item"><a class="post-list-link" href="/implement-erofs-fragment-dedupe.html">转：EROFS 碎片去重实践</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-enable-kasan-in-ubuntu-18-04-for-x86_64.html">How to enable KASAN in Ubuntu 18.04 for X86_64</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-analyze-segmentation-fault-for-non-install-package-in-ubuntu.html">如何分析 Linux user space's segmentation fault</a></li><li class="post-list-item"><a class="post-list-link" href="/prepare-fragment-dedupe-in-erofs.html">EROFS 碎片去重准备</a></li><li class="post-list-item"><a class="post-list-link" href="/good-naming-in-programming.html">优秀代码命名法</a></li><li class="post-list-item"><a class="post-list-link" href="/erofs-compressed-data-deduplication.html">EROFS 压缩去重分析</a></li><li class="post-list-item"><a class="post-list-link" href="/analyze-fscache-cookie-code.html">转：浅析 Linux FS-Cache</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-let-bluetooth-work-under-armbian-kodi-for-rockpi4b-within-metal-case.html">Rockpi4b Armbian Kodi 终于能使用蓝牙了</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">ARM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">Device Driver</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">File System</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">IoT</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">MSM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">Memory Management</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">Performance</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">Security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">Stability</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">Tools</a><span class="category-list-count">18</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>