<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>F2FS保留块特性分析及如何在Android上使用 | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">F2FS保留块特性分析及如何在Android上使用</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">F2FS保留块特性分析及如何在Android上使用</h1><div class="post-meta">2018-08-24</div><div class="post-content"><p>Android Go data分区启用了f2fs文件系统，从介绍看是为了提高life time和4K文件读写性能，这个暂不关心，三星init，看kernel提交记录后面主要是huawei也参与进来，据说是重金聘用，多少米?</p>
<p>前段时间项目在Go上遇到一个问题：data填满100%一直起不来(kernel: 3.18)。不过可以使用保留空间加一层保护, 重要系统进程可以使用保留区，其他不可用, rt?，ext4这个特性叫resgid，3.18 f2fs还不支持，我从kernel 4.9移下来，基于这份代码分析。</p>
<p>先看下保留空间相关结构：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">f2fs_sb_info</span> &#123;</span></span><br><span class="line">...</span><br><span class="line">	<span class="type">block_t</span> reserved_blocks;		<span class="comment">/* configurable reserved blocks */</span></span><br><span class="line">	<span class="type">block_t</span> current_reserved_blocks;	<span class="comment">/* current reserved blocks */</span></span><br><span class="line">	<span class="type">block_t</span> root_reserved_blocks;		<span class="comment">/* root reserved blocks */</span></span><br><span class="line">	<span class="type">kuid_t</span> s_resuid;			<span class="comment">/* reserved blocks for uid */</span></span><br><span class="line">	<span class="type">kgid_t</span> s_resgid;			<span class="comment">/* reserved blocks for gid */</span></span><br></pre></td></tr></table></figure>

<p>其实<code>reserved_blocks</code>和<code>current_reserved_blocks</code>是一个reserved feature，主要目的应该是提高性能，在sysfs下可配置。而<code>root_reserved_blocks</code>和<code>resuid</code>,<code>resgid</code>才是我们现在这个需求，用man来解释：</p>
<p>man mount:</p>
<blockquote>
<p>resgid&#x3D;n and resuid&#x3D;n<br>The  ext2  filesystem  reserves  a  certain percentage of the available space (by default 5%, see mke2fs(8) and tune2fs(8)).  These options determine who can use the reserved blocks.<br>(Roughly: whoever has the specified uid, or belongs to the specified group.)</p>
</blockquote>
<p>man tune2fs:</p>
<blockquote>
<p>-r reserved-blocks-count<br>Set the number of reserved filesystem blocks.</p>
<p>-g group<br>Set the group which can use the reserved filesystem blocks.  The group parameter can be a numerical gid or a group name.  If a group name is given, it is converted to a numerical gid before it is stored in the superblock.</p>
</blockquote>
<p>ok, 关键函数：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> __allow_reserved_blocks(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!test_opt(sbi, RESERVE_ROOT))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (capable(CAP_SYS_RESOURCE))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (uid_eq(sbi-&gt;s_resuid, current_fsuid()))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">if</span> (!gid_eq(sbi-&gt;s_resgid, GLOBAL_ROOT_GID) &amp;&amp;</span><br><span class="line">					in_group_p(sbi-&gt;s_resgid))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先检查mount是否有RESERVE_BOOT选项，如果没设置就不让用。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_opt(sbi, option)	((sbi)-&gt;mount_opt.opt |= F2FS_MOUNT_##option)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> test_opt(sbi, option)	((sbi)-&gt;mount_opt.opt &amp; F2FS_MOUNT_##option)</span></span><br></pre></td></tr></table></figure>

<p>哪里<code>set_opt</code>了这个了, 在<code>parse_options</code>里:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> Opt_reserve_root:</span><br><span class="line">	<span class="keyword">if</span> (args-&gt;from &amp;&amp; match_int(args, &amp;arg))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (test_opt(sbi, RESERVE_ROOT)) &#123;</span><br><span class="line">		f2fs_msg(sb, KERN_INFO,</span><br><span class="line">			<span class="string">&quot;Preserve previous reserve_root=%u&quot;</span>,</span><br><span class="line">			sbi-&gt;root_reserved_blocks);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">//tj: 走这里</span></span><br><span class="line">		sbi-&gt;root_reserved_blocks = arg;</span><br><span class="line">		set_opt(sbi, RESERVE_ROOT);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>mount会解析这个选项：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> dentry *<span class="title function_">f2fs_mount</span><span class="params">(<span class="keyword">struct</span> file_system_type *fs_type, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">			<span class="type">const</span> <span class="type">char</span> *dev_name, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> mount_bdev(fs_type, flags, dev_name, data, f2fs_fill_super);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>f2fs_fill_super</code>会call <code>parse_options</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">f2fs_fill_super</span><span class="params">(<span class="keyword">struct</span> super_block *sb, <span class="type">void</span> *data, <span class="type">int</span> silent)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">	<span class="comment">/* parse mount options */</span></span><br><span class="line">	options = kstrdup((<span class="type">const</span> <span class="type">char</span> *)data, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (data &amp;&amp; !options) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> free_sb_buf;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = parse_options(sb, options);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> free_options;</span><br></pre></td></tr></table></figure>

<p>ok, 看下<code>s_resgid</code> allow:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!gid_eq(sbi-&gt;s_resgid, GLOBAL_ROOT_GID) &amp;&amp;</span><br><span class="line">				in_group_p(sbi-&gt;s_resgid))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KGIDT_INIT(value) (kgid_t)&#123; value &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBAL_ROOT_GID KGIDT_INIT(0)</span></span><br></pre></td></tr></table></figure>

<p>resgid&#x3D;0的不让用保留了，<code>in_group_p</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check whether we&#x27;re fsgid/egid or in the supplemental group..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">in_group_p</span><span class="params">(<span class="type">kgid_t</span> grp)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span> =</span> current_cred();</span><br><span class="line">        <span class="type">int</span> retval = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gid_eq(grp, cred-&gt;fsgid))</span><br><span class="line">                retval = groups_search(cred-&gt;group_info, grp);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应该就是这个grp有没有加到系统里，可见mount flag要加了<code>reserve_root</code>才能激活。</p>
<p>另外，保留块有大小限制：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">limit_reserve_root</span><span class="params">(<span class="keyword">struct</span> f2fs_sb_info *sbi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">block_t</span> limit = (sbi-&gt;user_block_count &lt;&lt; <span class="number">1</span>) / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* limit is 0.2% */</span></span><br><span class="line">	<span class="keyword">if</span> (test_opt(sbi, RESERVE_ROOT) &amp;&amp; sbi-&gt;root_reserved_blocks &gt; limit) &#123;</span><br><span class="line">		sbi-&gt;root_reserved_blocks = limit;</span><br><span class="line">		f2fs_msg(sbi-&gt;sb, KERN_INFO,</span><br><span class="line">			<span class="string">&quot;Reduce reserved blocks for root = %u&quot;</span>,</span><br><span class="line">				sbi-&gt;root_reserved_blocks);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!test_opt(sbi, RESERVE_ROOT) &amp;&amp;</span><br><span class="line">		(!uid_eq(sbi-&gt;s_resuid,</span><br><span class="line">				make_kuid(&amp;init_user_ns, F2FS_DEF_RESUID)) ||</span><br><span class="line">		!gid_eq(sbi-&gt;s_resgid,</span><br><span class="line">				make_kgid(&amp;init_user_ns, F2FS_DEF_RESGID))))</span><br><span class="line">		f2fs_msg(sbi-&gt;sb, KERN_INFO,</span><br><span class="line">			<span class="string">&quot;Ignore s_resuid=%u, s_resgid=%u w/o reserve_root&quot;</span>,</span><br><span class="line">				from_kuid_munged(&amp;init_user_ns, sbi-&gt;s_resuid),</span><br><span class="line">				from_kgid_munged(&amp;init_user_ns, sbi-&gt;s_resgid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于id，Android里叫AID，在system&#x2F;core&#x2F;libcutils&#x2F;include&#x2F;private&#x2F;android_filesystem_config.h:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AID_RESERVED_DISK 1065   <span class="comment">/* GID that has access to reserved disk space */</span></span></span><br></pre></td></tr></table></figure>

<p>比如zygote能使用reserved disk，在32bits系统里在rootdir&#x2F;init.zygote32.rc加入reserved_disk,如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">    class main</span><br><span class="line">    priority -20</span><br><span class="line">    user root</span><br><span class="line">    group root readproc reserved_disk</span><br></pre></td></tr></table></figure>

<p>可以用id命令显示uid&#x2F;gid等信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xxx:/ <span class="comment"># ps -A | grep system_server</span></span><br><span class="line">USER           PID  PPID     VSZ    RSS WCHAN            ADDR S NAME</span><br><span class="line">system        2888   286 1127972  73976 SyS_epoll_wait b008a658 S system_server</span><br><span class="line">xxx:/ <span class="comment">#</span></span><br><span class="line">xxx:/ <span class="comment"># id system</span></span><br><span class="line">uid=1000(system) gid=1000(system) <span class="built_in">groups</span>=1000(system), context=u:r:su:s0</span><br><span class="line">xxx:/ <span class="comment">#</span></span><br><span class="line">xxx:/ <span class="comment"># id reserved_disk</span></span><br><span class="line">uid=1065(reserved_disk) gid=1065(reserved_disk) <span class="built_in">groups</span>=1065(reserved_disk), cont</span><br><span class="line">ext=u:r:su:s0</span><br></pre></td></tr></table></figure>

<p>Done.</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/resgid"><i class="fa fa-tag">resgid</i></a></div><div class="post-nav"><a class="pre" href="/analyze1-lmkd-for-android-p.html">Android P LMKD分析一</a><a class="next" href="/analyze-boot-failed-when-full-data-part-under-android-go.html">Android Go在data分区填近满后不能启动bug分析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/how-to-use-adeb-to-install-bcc-into-android.html">转: 使用 adeb 在 Android 上编译安装 bcc</a></li><li class="post-list-item"><a class="post-list-link" href="/kworker-sched-la-stat.html">kworker 调度延迟性能测试和统计</a></li><li class="post-list-item"><a class="post-list-link" href="/implement-erofs-fragment-dedupe.html">转：EROFS 碎片去重实践</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-enable-kasan-in-ubuntu-18-04-for-x86_64.html">How to enable KASAN in Ubuntu 18.04 for X86_64</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-analyze-segmentation-fault-for-non-install-package-in-ubuntu.html">如何分析 Linux user space's segmentation fault</a></li><li class="post-list-item"><a class="post-list-link" href="/prepare-fragment-dedupe-in-erofs.html">EROFS 碎片去重准备</a></li><li class="post-list-item"><a class="post-list-link" href="/good-naming-in-programming.html">优秀代码命名法</a></li><li class="post-list-item"><a class="post-list-link" href="/erofs-compressed-data-deduplication.html">EROFS 压缩去重分析</a></li><li class="post-list-item"><a class="post-list-link" href="/analyze-fscache-cookie-code.html">转：浅析 Linux FS-Cache</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-let-bluetooth-work-under-armbian-kodi-for-rockpi4b-within-metal-case.html">Rockpi4b Armbian Kodi 终于能使用蓝牙了</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">ARM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">Device Driver</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">File System</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">IoT</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">MSM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">Memory Management</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">Performance</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">Security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">Stability</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">Tools</a><span class="category-list-count">18</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>