<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>SELinux:如何快速验证file_contexts | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SELinux:如何快速验证file_contexts</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SELinux:如何快速验证file_contexts</h1><div class="post-meta">2018-03-12</div><div class="post-content"><p>system&#x2F;core&#x2F;fs_mgr里加入一个resize工具，有权限问题log如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[   19.952455] audit: type=1400 audit(83369.909:5): avc:  denied  &#123; execute_no_trans &#125; for  pid=283 comm=&quot;init&quot; path=&quot;/system/bin/resize.f2fs&quot; dev=&quot;mmcblk0p35&quot; ino=1952 scontext=u:r:init:s0 tcontext=u:object_r:system_file:s0 tclass=file permissive=1</span><br></pre></td></tr></table></figure>

<p>这个log就是sepolicy不允许init执行&#x2F;system&#x2F;bin&#x2F;resize.f2fs。</p>
<p>Android 8.0里init.te规则要求init在执行程序时需要增加新的domain。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line"># init should never execute a program without changing to another domain.</span><br><span class="line">neverallow init &#123; file_type fs_type &#125;:file execute_no_trans;</span><br></pre></td></tr></table></figure>

<p>ok，不用新建domain，参考e2fsck添加resize.f2fs到file_contexts的fsck domain里即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/system/bin/resize\.f2fs  --  u:object_r:fsck_exec:s0</span><br></pre></td></tr></table></figure>

<p>修改完后如何验证是个问题，编译烧录boot.img后ls -Z看了下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">u:object_r:system_file:s0 /system/bin/resize.f2fs</span><br></pre></td></tr></table></figure>

<p>明显没有生效，难道要编译system.img么，Xeon估计至少也要1h。</p>
<p>先看下sepolicy下的Android.mk，里面有个生成file_contexts.bin模块的脚本:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">LOCAL_MODULE := file_contexts.bin</span><br><span class="line">LOCAL_MODULE_CLASS := ETC</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_MODULE_PATH := <span class="variable">$(TARGET_ROOT_OUT)</span></span><br></pre></td></tr></table></figure>

<p>进入&#x2F;system&#x2F;sepolicy，mma -j4编译后会生成在如下路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">obj/ETC/file_contexts.bin_intermediates/file_contexts.bin</span><br></pre></td></tr></table></figure>

<p>ok，下一步把当前的system.img解压出来再用新的file_contexts.bin重新生成即可。</p>
<p>注意要把这个工具放入system目录再生成img才会生效，官方文档有介绍：</p>
<blockquote>
<p>file_contexts - Located in the sepolicy subdirectory. This file assigns labels to files and is used by various userspace components. As you create new policies, create or update this file to assign new labels to files. In order to apply new file_contexts, you must rebuild the filesystem image or run restorecon on the file to be relabeled. On upgrades, changes to file_contexts are automatically applied to the system and userdata partitions as part of the upgrade. Changes can also be automatically applied on upgrade to other partitions by adding restorecon_recursive calls to your init.board.rc file after the partition has been mounted read-write. </p>
</blockquote>
<p>试了下adb push进用restorecon好像没有改过来，暂且略过。</p>
<p>btw: 其他的te文件修改编译boot.img，生成也在ETC&#x2F;下。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/selinux"><i class="fa fa-tag">selinux</i></a></div><div class="post-nav"><a class="pre" href="/how-to-get-volume-key-pressed.html">内核如何获取音量键按下的状态</a><a class="next" href="/how-to-debug-tf-card-detect-issue.html">TF卡不能检卡问题排查</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/convert-typecho-to-hexo.html">I am back!</a></li><li class="post-list-item"><a class="post-list-link" href="/review-freezing-issue-when-drag-icon-after-ohos-adaption.html">OpenHarmony适配后图标拖拽卡屏问题回顾</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-fix-parse-too-complex-in-source-insight.html">Source Insight 自定义解析</a></li><li class="post-list-item"><a class="post-list-link" href="/adapt-ohos-for-mali-g57-on-sprd-t606.html">转：拥抱鸿蒙 - 在展讯T606平台上的探索与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/essential-inventory-of-adaption-for-unisoc-platform-androidt-based.html">展讯平台 OpenHarmony 3.2.2 适配基础盘点</a></li><li class="post-list-item"><a class="post-list-link" href="/porting-openharmony-linux-kernel-to-3rd-party-chip.html">快速移植 OpenHarmony Linux 内核到三方 ARM64 平台</a></li><li class="post-list-item"><a class="post-list-link" href="/openharmony-linux-kernel-overview.html">初识 OpenHarmony Linux Kernel</a></li><li class="post-list-item"><a class="post-list-link" href="/what-android-gki-brings-to-oems.html">What Android GKI Brings to OEMs</a></li><li class="post-list-item"><a class="post-list-link" href="/analyze-erofs-pcluster-mode.html">转：EROFS pcluster 模式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/why-cpu-intensive-work-is-meaningless-for-unbound-wq.html">为什么 WQ_CPU_INTENSIVE 对 unbound 工作队列没有意义</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">arm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">dd</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ebpf/">ebpf</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">fs</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">iot</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">mm</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">msm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ohos/">ohos</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">stab</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">19</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>