<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Kernel Panic实例分析三:Unable to handle kernel paging request | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kernel Panic实例分析三:Unable to handle kernel paging request</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kernel Panic实例分析三:Unable to handle kernel paging request</h1><div class="post-meta">2020-11-19</div><div class="post-content"><p>QC armv7平台kernel 4.x出现的死机问题，一开始很随机以为是DDR硬件问题，直到后面死机越來越多，还出现过pc一样的现场，让人不得不怀疑是SW issue，同步提给QC看，看QC的答复就是用tracer32来定位的，下来温习了下armv7，完全可以用red hat的crash工具结合反汇编和源码分析定位，对小厂算是节约license成本了?</p>
<p>我们先看死机现场:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">551 [   63.694025] Unable to handle kernel paging request at virtual address 383c0a1d</span><br><span class="line">552 [   63.694034] pgd = db387da1</span><br><span class="line">553 [   63.694036] [383c0a1d] *pgd=00000000</span><br><span class="line">554 [   63.694045] Internal error: Oops: 5 [#1] PREEMPT SMP ARM</span><br><span class="line">555 [   63.694048] Modules linked in: machine_ext_dlkm(O) machine_dlkm(O) cpe_lsm_dlkm(O) wcd_cpe_dlkm(O) analog_cdc_dlkm(O) aw87359_dlkm(O) digital_cdc_dlkm(O) stub_dlkm(O) mbhc_dlkm(O) wcd    9xxx_dlkm(O) wcd_core_dlkm(O) swr_ctrl_dlkm(O) swr_dlkm(O) pinctrl_wcd_dlkm(O) native_dlkm(O) platform_dlkm(O) usf_dlkm(O) q6_dlkm(O) adsp_loader_dlkm(O) apr_dlkm(O) q6_notifier_dlkm(O)</span><br><span class="line">558 [   63.694126] task: b4fb24a1 task.stack: 4ddc1adc</span><br><span class="line">559 [   63.694137] PC is at kernfs_find_ns+0x78/0xf8</span><br><span class="line">560 [   63.694143] LR is at kernfs_name_hash+0x10/0x68</span><br><span class="line">561 [   63.694147] pc : [&lt;c02dc290&gt;]    lr : [&lt;c02db85c&gt;]    psr: 200b0013</span><br><span class="line">562                sp : d9fa9d68  ip : 00000000  fp : 00000000</span><br><span class="line">563 [   63.694150] r10: d9fa9ec0  r9 : 00000011  r8 : e47522a8</span><br><span class="line">564 [   63.694153] r7 : 00000000  r6 : e4477bdc  r5 : 5d64df2d  r4 : 383c0a0d</span><br><span class="line">565 [   63.694156] r3 : 7473616d  r2 : 00000031  r1 : 26e33aa1  r0 : 5d64df2d</span><br><span class="line">...</span><br><span class="line">599 [   63.694571] Stack: (0xd9fa9d68 to 0xd9faa000)</span><br><span class="line">600 [   63.694577] 9d60:                   e47522a8 000409e3 00080040 ea0172d0 e4477bb0 e9d9bbe8</span><br><span class="line">601 [   63.694584] 9d80: e9d9bc60 c02dc3d8 e4477bb0 c13091c8 e9d9bbe8 c026d0a8 00000000 d9fa9d9c</span><br><span class="line">602 [   63.694591] 9da0: d9fa9d9c 000409e3 00000000 00000001 d9fa9eb8 00000000 c13091c8 d9fa9eb8</span><br><span class="line">603 [   63.694599] 9dc0: d9fa8000 e47522a8 00000009 c0271234 c11532d0 e9d9bbe8 00000001 d9fa9eb8</span><br><span class="line">604 [   63.694607] 9de0: d9fa8000 000409e3 b4ea6d82 61c88647 c13091c8 cedc902a d9fa9eb8 c0271488</span><br><span class="line">605 [   63.694615] 9e00: 00000000 00000009 00000142 c03c2560 c03c2524 c1153ae8 c1153358 c03bead0</span><br><span class="line">606 [   63.694623] 9e20: c50ed480 000409e3 d9fa9eb8 d9fa9eb8 d9fa9f70 cedc9010 00000001 c50ed480</span><br><span class="line">607 [   63.694631] 9e40: d9fa8000 00000142 00000009 c0271a58 ebaa2908 c01a0b30 eba0e440 eba0e490</span><br><span class="line">621 [   63.694751] [&lt;c02dc290&gt;] (kernfs_find_ns) from [&lt;c02dc3d8&gt;] (kernfs_iop_lookup+0x48/0xd8)</span><br><span class="line">622 [   63.694760] [&lt;c02dc3d8&gt;] (kernfs_iop_lookup) from [&lt;c026d0a8&gt;] (lookup_slow+0x94/0x158)</span><br><span class="line">623 [   63.694768] [&lt;c026d0a8&gt;] (lookup_slow) from [&lt;c0271234&gt;] (walk_component+0x1fc/0x2cc)</span><br><span class="line">624 [   63.694775] [&lt;c0271234&gt;] (walk_component) from [&lt;c0271488&gt;] (link_path_walk+0x184/0x4e4)</span><br><span class="line">625 [   63.694782] [&lt;c0271488&gt;] (link_path_walk) from [&lt;c0271a58&gt;] (path_openat+0x88/0xc70)</span><br><span class="line">626 [   63.694789] [&lt;c0271a58&gt;] (path_openat) from [&lt;c02739f8&gt;] (do_filp_open+0x6c/0x110)</span><br><span class="line">627 [   63.694797] [&lt;c02739f8&gt;] (do_filp_open) from [&lt;c0261074&gt;] (do_sys_open+0x128/0x23c)</span><br><span class="line">628 [   63.694806] [&lt;c0261074&gt;] (do_sys_open) from [&lt;c0108b40&gt;] (ret_fast_syscall+0x0/0x54)</span><br><span class="line">629 [   63.694814] Code: aa00000c e5944008 e3540000 0a000006 (e5943010)</span><br><span class="line">630 [   63.694818] ---[ end trace 9656f9b4178497a9 ]---</span><br></pre></td></tr></table></figure>

<p>非法地址访问，当前pc是c02dc290, 在<code>kernfs_find_ns</code>里。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">crash.arm&gt; sym c02dc290</span><br><span class="line">c02dc290 (t) kernfs_find_ns+120 .../fs/kernfs/dir.c: 306</span><br></pre></td></tr></table></figure>

<p>找到对应的c code:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">303</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">kernfs_name_compare</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> hash, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="number">304</span>                                <span class="type">const</span> <span class="type">void</span> *ns, <span class="type">const</span> <span class="keyword">struct</span> kernfs_node *kn)</span></span><br><span class="line">305 &#123;</span><br><span class="line"><span class="number">306</span>         <span class="keyword">if</span> (hash &lt; kn-&gt;hash) <span class="comment">//pc</span></span><br><span class="line"><span class="number">307</span>                 <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p><code>kernfs_find_ns()</code> calls <code>kernfs_name_compare()</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">737</span> <span class="type">static</span> <span class="keyword">struct</span> kernfs_node *<span class="title function_">kernfs_find_ns</span><span class="params">(<span class="keyword">struct</span> kernfs_node *parent,</span></span><br><span class="line"><span class="params"><span class="number">738</span>                                           <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="number">739</span>                                           <span class="type">const</span> <span class="type">void</span> *ns)</span></span><br><span class="line">740 &#123;</span><br><span class="line"><span class="number">741</span>         <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">node</span> =</span> parent-&gt;dir.children.rb_node;</span><br><span class="line"><span class="number">742</span>         <span class="type">bool</span> has_ns = kernfs_ns_enabled(parent);</span><br><span class="line"><span class="number">743</span>         <span class="type">unsigned</span> <span class="type">int</span> hash;</span><br><span class="line"><span class="number">744</span></span><br><span class="line"><span class="number">745</span>         lockdep_assert_held(&amp;kernfs_mutex);</span><br><span class="line"><span class="number">746</span></span><br><span class="line"><span class="number">747</span>         <span class="keyword">if</span> (has_ns != (<span class="type">bool</span>)ns) &#123;</span><br><span class="line"><span class="number">748</span>                 WARN(<span class="number">1</span>, KERN_WARNING <span class="string">&quot;kernfs: ns %s in &#x27;%s&#x27; for &#x27;%s&#x27;\n&quot;</span>,</span><br><span class="line"><span class="number">749</span>                      has_ns ? <span class="string">&quot;required&quot;</span> : <span class="string">&quot;invalid&quot;</span>, parent-&gt;name, name);</span><br><span class="line"><span class="number">750</span>                 <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">751</span>         &#125;</span><br><span class="line"><span class="number">752</span></span><br><span class="line"><span class="number">753</span>         hash = kernfs_name_hash(name, ns);</span><br><span class="line"><span class="number">754</span>         <span class="keyword">while</span> (node) &#123;</span><br><span class="line"><span class="number">755</span>                 <span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">kn</span>;</span></span><br><span class="line"><span class="number">756</span>                 <span class="type">int</span> result;</span><br><span class="line"><span class="number">757</span></span><br><span class="line"><span class="number">758</span>                 kn = rb_to_kn(node);</span><br><span class="line"><span class="number">759</span>                 result = kernfs_name_compare(hash, name, ns, kn); <span class="comment">//tj: here</span></span><br><span class="line"><span class="number">760</span>                 <span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">761</span>                         node = node-&gt;rb_left;</span><br><span class="line"><span class="number">762</span>                 <span class="keyword">else</span> <span class="keyword">if</span> (result &gt; <span class="number">0</span>)</span><br><span class="line"><span class="number">763</span>                         node = node-&gt;rb_right;</span><br><span class="line"><span class="number">764</span>                 <span class="keyword">else</span></span><br><span class="line"><span class="number">765</span>                         <span class="keyword">return</span> kn;</span><br><span class="line"><span class="number">766</span>         &#125;</span><br><span class="line"><span class="number">767</span>         <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">768</span> &#125;</span><br></pre></td></tr></table></figure>

<p><code>kernfs_find_ns</code> lr：c02dc3d8</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">crash.arm&gt; sym c02dc3d8</span><br><span class="line">c02dc3d8 (t) kernfs_iop_lookup+72 .../fs/kernfs/dir.c: 990</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">972</span> <span class="type">static</span> <span class="keyword">struct</span> dentry *<span class="title function_">kernfs_iop_lookup</span><span class="params">(<span class="keyword">struct</span> inode *dir,</span></span><br><span class="line"><span class="params"><span class="number">973</span>                                         <span class="keyword">struct</span> dentry *dentry,</span></span><br><span class="line"><span class="params"><span class="number">974</span>                                         <span class="type">unsigned</span> <span class="type">int</span> flags)</span></span><br><span class="line">975 &#123;</span><br><span class="line"><span class="number">976</span>         <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">ret</span>;</span></span><br><span class="line"><span class="number">977</span>         <span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">parent</span> =</span> dentry-&gt;d_parent-&gt;d_fsdata;</span><br><span class="line"><span class="number">978</span>         <span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">kn</span>;</span></span><br><span class="line"><span class="number">979</span>         <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"><span class="number">980</span>         <span class="type">const</span> <span class="type">void</span> *ns = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">981</span></span><br><span class="line"><span class="number">982</span>         mutex_lock(&amp;kernfs_mutex);</span><br><span class="line"><span class="number">983</span></span><br><span class="line"><span class="number">984</span>         <span class="keyword">if</span> (kernfs_ns_enabled(parent))</span><br><span class="line"><span class="number">985</span>                 ns = kernfs_info(dir-&gt;i_sb)-&gt;ns;</span><br><span class="line"><span class="number">986</span></span><br><span class="line"><span class="number">987</span>         kn = kernfs_find_ns(parent, dentry-&gt;d_name.name, ns);</span><br><span class="line"><span class="number">988</span></span><br><span class="line"><span class="number">989</span>         <span class="comment">/* no such entry */</span></span><br><span class="line"><span class="number">990</span>         <span class="keyword">if</span> (!kn || !kernfs_active(kn)) &#123; <span class="comment">//tj: here</span></span><br><span class="line"><span class="number">991</span>                 ret = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">992</span>                 <span class="keyword">goto</span> out_unlock;</span><br><span class="line"><span class="number">993</span>         &#125;</span><br></pre></td></tr></table></figure>

<p>ok, 先有个代码印象，下面看下出错附近的反汇编：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">crash.arm&gt; dis kernfs_find_ns</span><br><span class="line">0xc02dc218 &lt;kernfs_find_ns&gt;:    push    &#123;r4, r5, r6, r7, lr&#125;</span><br><span class="line">0xc02dc21c &lt;kernfs_find_ns+4&gt;:  adds    r12, r2, #0</span><br><span class="line">0xc02dc220 &lt;kernfs_find_ns+8&gt;:  ldrh    r3, [r0, #68]   ; 0x44</span><br><span class="line">0xc02dc224 &lt;kernfs_find_ns+12&gt;: mov     r6, r1</span><br><span class="line">0xc02dc228 &lt;kernfs_find_ns+16&gt;: movne   r12, #1</span><br><span class="line">0xc02dc22c &lt;kernfs_find_ns+20&gt;: sub     sp, sp, #12</span><br><span class="line">0xc02dc230 &lt;kernfs_find_ns+24&gt;: ubfx    r1, r3, #5, #1</span><br><span class="line">0xc02dc234 &lt;kernfs_find_ns+28&gt;: ldr     r4, [r0, #44]   ; 0x2c</span><br><span class="line">0xc02dc238 &lt;kernfs_find_ns+32&gt;: cmp     r1, r12</span><br><span class="line">0xc02dc23c &lt;kernfs_find_ns+36&gt;: bne     0xc02dc2c8 &lt;kernfs_find_ns+176&gt;</span><br><span class="line">0xc02dc240 &lt;kernfs_find_ns+40&gt;: mov     r0, r6</span><br><span class="line">0xc02dc244 &lt;kernfs_find_ns+44&gt;: mov     r1, r2</span><br><span class="line">0xc02dc248 &lt;kernfs_find_ns+48&gt;: mov     r7, r2</span><br><span class="line">0xc02dc24c &lt;kernfs_find_ns+52&gt;: bl      0xc02db84c &lt;kernfs_name_hash&gt;</span><br><span class="line">0xc02dc250 &lt;kernfs_find_ns+56&gt;: cmp     r4, #0</span><br><span class="line">0xc02dc254 &lt;kernfs_find_ns+60&gt;: mov     r5, r0</span><br><span class="line">0xc02dc258 &lt;kernfs_find_ns+64&gt;: bne     0xc02dc290 &lt;kernfs_find_ns+120&gt;</span><br><span class="line">0xc02dc25c &lt;kernfs_find_ns+68&gt;: b       0xc02dc308 &lt;kernfs_find_ns+240&gt;</span><br><span class="line">0xc02dc260 &lt;kernfs_find_ns+72&gt;: ldr     r3, [r4, #12]</span><br><span class="line">0xc02dc264 &lt;kernfs_find_ns+76&gt;: mov     r0, r6</span><br><span class="line">0xc02dc268 &lt;kernfs_find_ns+80&gt;: cmp     r7, r3</span><br><span class="line">0xc02dc26c &lt;kernfs_find_ns+84&gt;: bcc     0xc02dc284 &lt;kernfs_find_ns+108&gt;</span><br><span class="line">0xc02dc270 &lt;kernfs_find_ns+88&gt;: bhi     0xc02dc2a0 &lt;kernfs_find_ns+136&gt;</span><br><span class="line">0xc02dc274 &lt;kernfs_find_ns+92&gt;: ldr     r1, [r4, #-4]</span><br><span class="line">0xc02dc278 &lt;kernfs_find_ns+96&gt;: bl      0xc0444610 &lt;strcmp&gt;</span><br><span class="line">0xc02dc27c &lt;kernfs_find_ns+100&gt;:        cmp     r0, #0</span><br><span class="line">0xc02dc280 &lt;kernfs_find_ns+104&gt;:        bge     0xc02dc2b8 &lt;kernfs_find_ns+160&gt;</span><br><span class="line">0xc02dc284 &lt;kernfs_find_ns+108&gt;:        ldr     r4, [r4, #8]</span><br><span class="line">0xc02dc288 &lt;kernfs_find_ns+112&gt;:        cmp     r4, #0</span><br><span class="line">0xc02dc28c &lt;kernfs_find_ns+116&gt;:        beq     0xc02dc2ac &lt;kernfs_find_ns+148&gt;</span><br><span class="line">0xc02dc290 &lt;kernfs_find_ns+120&gt;:        ldr     r3, [r4, #16]</span><br><span class="line">0xc02dc294 &lt;kernfs_find_ns+124&gt;:        cmp     r5, r3</span><br><span class="line">0xc02dc298 &lt;kernfs_find_ns+128&gt;:        bcc     0xc02dc284 &lt;kernfs_find_ns+108&gt;</span><br><span class="line">0xc02dc29c &lt;kernfs_find_ns+132&gt;:        bls     0xc02dc260 &lt;kernfs_find_ns+72&gt;</span><br><span class="line">0xc02dc2a0 &lt;kernfs_find_ns+136&gt;:        ldr     r4, [r4, #4]</span><br><span class="line">0xc02dc2a4 &lt;kernfs_find_ns+140&gt;:        cmp     r4, #0</span><br><span class="line">0xc02dc2a8 &lt;kernfs_find_ns+144&gt;:        bne     0xc02dc290 &lt;kernfs_find_ns+120&gt;</span><br><span class="line">0xc02dc2ac &lt;kernfs_find_ns+148&gt;:        mov     r0, #0</span><br><span class="line">0xc02dc2b0 &lt;kernfs_find_ns+152&gt;:        add     sp, sp, #12</span><br><span class="line">0xc02dc2b4 &lt;kernfs_find_ns+156&gt;:        pop     &#123;r4, r5, r6, r7, pc&#125;</span><br><span class="line">0xc02dc2b8 &lt;kernfs_find_ns+160&gt;:        bne     0xc02dc2a0 &lt;kernfs_find_ns+136&gt;</span><br><span class="line">0xc02dc2bc &lt;kernfs_find_ns+164&gt;:        sub     r0, r4, #16</span><br><span class="line">0xc02dc2c0 &lt;kernfs_find_ns+168&gt;:        add     sp, sp, #12</span><br><span class="line">0xc02dc2c4 &lt;kernfs_find_ns+172&gt;:        pop     &#123;r4, r5, r6, r7, pc&#125;</span><br><span class="line">0xc02dc2c8 &lt;kernfs_find_ns+176&gt;:        ldr     lr, [r0, #12]</span><br><span class="line">0xc02dc2cc &lt;kernfs_find_ns+180&gt;:        cmp     r1, #0</span><br><span class="line">0xc02dc2d0 &lt;kernfs_find_ns+184&gt;:        movw    r12, #22808     ; 0x5918</span><br><span class="line">0xc02dc2d4 &lt;kernfs_find_ns+188&gt;:        movw    r3, #46236      ; 0xb49c</span><br><span class="line">0xc02dc2d8 &lt;kernfs_find_ns+192&gt;:        movt    r12, #49410     ; 0xc102</span><br><span class="line">0xc02dc2dc &lt;kernfs_find_ns+196&gt;:        movw    r0, #46068      ; 0xb3f4</span><br><span class="line">0xc02dc2e0 &lt;kernfs_find_ns+200&gt;:        movw    r2, #46244      ; 0xb4a4</span><br><span class="line">0xc02dc2e4 &lt;kernfs_find_ns+204&gt;:        movt    r3, #49404      ; 0xc0fc</span><br><span class="line">0xc02dc2e8 &lt;kernfs_find_ns+208&gt;:        str     r6, [sp, #4]</span><br><span class="line">0xc02dc2ec &lt;kernfs_find_ns+212&gt;:        movt    r0, #49404      ; 0xc0fc</span><br><span class="line">0xc02dc2f0 &lt;kernfs_find_ns+216&gt;:        str     lr, [sp]</span><br><span class="line">0xc02dc2f4 &lt;kernfs_find_ns+220&gt;:        movne   r3, r12</span><br><span class="line">0xc02dc2f8 &lt;kernfs_find_ns+224&gt;:        movt    r2, #49404      ; 0xc0fc</span><br><span class="line">0xc02dc2fc &lt;kernfs_find_ns+228&gt;:        movw    r1, #749        ; 0x2ed</span><br><span class="line">0xc02dc300 &lt;kernfs_find_ns+232&gt;:        bl      0xc012aecc &lt;warn_slowpath_fmt&gt;</span><br><span class="line">0xc02dc304 &lt;kernfs_find_ns+236&gt;:        b       0xc02dc2ac &lt;kernfs_find_ns+148&gt;</span><br><span class="line">0xc02dc308 &lt;kernfs_find_ns+240&gt;:        mov     r0, r4</span><br><span class="line">0xc02dc30c &lt;kernfs_find_ns+244&gt;:        b       0xc02dc2b0 &lt;kernfs_find_ns+152&gt;</span><br></pre></td></tr></table></figure>

<p>pc是这里：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xc02dc290 &lt;kernfs_find_ns+120&gt;:        ldr     r3, [r4, #16]</span><br></pre></td></tr></table></figure>

<p>死机现场<code>r4 : 383c0a0d</code>，r4+16就是383c0a1d了，也就是log出现的那个非法地址访问:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">551 [   63.694025] Unable to handle kernel paging request at virtual address 383c0a1d</span><br></pre></td></tr></table></figure>

<p>+16是啥？我们看c code:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">303</span> <span class="type">static</span> <span class="type">int</span> <span class="title function_">kernfs_name_compare</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> hash, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="number">304</span>                                <span class="type">const</span> <span class="type">void</span> *ns, <span class="type">const</span> <span class="keyword">struct</span> kernfs_node *kn)</span></span><br><span class="line">305 &#123;</span><br><span class="line"><span class="number">306</span>         <span class="keyword">if</span> (hash &lt; kn-&gt;hash) <span class="comment">//pc</span></span><br><span class="line"><span class="number">307</span>                 <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p>会是<code>-&gt;hash</code>吗？<code>-&gt;hash</code>的偏移：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">crash.arm&gt; struct kernfs_node.hash</span><br><span class="line">struct kernfs_node &#123;</span><br><span class="line">  [32] unsigned int hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不对。继续看反汇编，可以借助-l打印出code行数帮助定位：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.../fs/kernfs/dir.c: 754</span><br><span class="line">0xc02dc288 &lt;kernfs_find_ns+112&gt;:        cmp     r4, #0 </span><br><span class="line">0xc02dc28c &lt;kernfs_find_ns+116&gt;:        beq     0xc02dc2ac &lt;kernfs_find_ns+148&gt;</span><br><span class="line">.../fs/kernfs/dir.c: 306</span><br><span class="line">0xc02dc290 &lt;kernfs_find_ns+120&gt;:        ldr     r3, [r4, #16] //tj: pc</span><br></pre></td></tr></table></figure>

<p>754行：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">754</span>         <span class="keyword">while</span> (node) &#123;</span><br><span class="line"><span class="number">755</span>                 <span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">kn</span>;</span></span><br></pre></td></tr></table></figure>

<p>0xc02dc2ac:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.../fs/kernfs/dir.c: 750</span><br><span class="line">0xc02dc2ac &lt;kernfs_find_ns+148&gt;:        mov     r0, #0</span><br><span class="line">.../fs/kernfs/dir.c: 768</span><br><span class="line">0xc02dc2b0 &lt;kernfs_find_ns+152&gt;:        add     sp, sp, #12</span><br><span class="line">0xc02dc2b4 &lt;kernfs_find_ns+156&gt;:        pop     &#123;r4, r5, r6, r7, pc&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="number">750</span>                 <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">...</span><br><span class="line"> <span class="number">767</span>         <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"> <span class="number">768</span> &#125;</span><br></pre></td></tr></table></figure>

<p>到这里可以推断r4是node，那这个推断对不对了，我们继续分析，后面主要会从反汇编&#x2F;c&#x2F;armv7栈以及crash工具的使用推导计算出log里的非法地址,大概还有一半多的内容。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/panic"><i class="fa fa-tag">panic</i></a></div><div class="post-nav"><a class="pre" href="/slow-movie-raspberrypi-based-using-epaper.html">超慢速电影播放相框</a><a class="next" href="/how-to-get-kaslr-offset-on-arm64.html">How to get kaslr offset on ARM64</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/upgrade-my-custom-build-server-amd-based.html">我的PC组装升级记</a></li><li class="post-list-item"><a class="post-list-link" href="/convert-typecho-to-hexo.html">I am back!</a></li><li class="post-list-item"><a class="post-list-link" href="/review-freezing-issue-when-drag-icon-after-ohos-adaption.html">OpenHarmony适配后图标拖拽卡屏问题回顾</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-fix-parse-too-complex-in-source-insight.html">Source Insight 自定义解析</a></li><li class="post-list-item"><a class="post-list-link" href="/adapt-ohos-for-mali-g57-on-sprd-t606.html">转：拥抱鸿蒙 - 在展讯T606平台上的探索与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/essential-inventory-of-adaption-for-unisoc-platform-androidt-based.html">展讯平台 OpenHarmony 3.2.2 适配基础盘点</a></li><li class="post-list-item"><a class="post-list-link" href="/porting-openharmony-linux-kernel-to-3rd-party-chip.html">快速移植 OpenHarmony Linux 内核到三方 ARM64 平台</a></li><li class="post-list-item"><a class="post-list-link" href="/openharmony-linux-kernel-overview.html">初识 OpenHarmony Linux Kernel</a></li><li class="post-list-item"><a class="post-list-link" href="/what-android-gki-brings-to-oems.html">What Android GKI Brings to OEMs</a></li><li class="post-list-item"><a class="post-list-link" href="/analyze-erofs-pcluster-mode.html">转：EROFS pcluster 模式分析</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">arm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">dd</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ebpf/">ebpf</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">fs</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">iot</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">mm</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">msm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ohos/">ohos</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">stab</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">20</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>