<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Android boot state说明 | TJ的技术博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android boot state说明</h1><a id="logo" href="/.">TJ的技术博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 首页</i></a><a href="/archives/"><i class="fa undefined"> 归档</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android boot state说明</h1><div class="post-meta">2019-11-23</div><div class="post-content"><p>之前遇到了avb提示”device is corrupt”的问题，涉及boot state。我们先看下官方的说明，目前是Android 10：</p>
<blockquote>
<p>After determining the boot state of a device, you need to communicate that state to the user. If the device doesn’t have any issues, then proceed without displaying anything. Verified Boot issues fall into these categories:</p>
<ul>
<li>YELLOW: Warning screen for LOCKED devices with custom root of trust set</li>
<li>ORANGE: Warning screen for UNLOCKED devices</li>
<li>RED (eio): Warning screen for dm-verity corruption</li>
<li>RED (no os found): No valid OS found</li>
</ul>
</blockquote>
<p>YELLOW先略过，ORAGE就是当前设备unlocked了，以前也有文章分析过。这里主要看下之前遇到的RED eio state(屏幕打印txt一样)：</p>
<blockquote>
<p>dm-verity corruption</p>
<p>Show a RED eio screen if a valid version of Android is found and the device is currently in the eio dm-verity mode. The user needs to click the power button to continue. If the user hasn’t acknowledged the warning screen within 30 seconds, the device powers off (to protect the screen against burn-in and save power).</p>
</blockquote>
<p>如果找到一个有效的Android版本并且当前设备是在eio dm-verity mode时show RED eio screen。</p>
<p><img src="http://tjtech.me/usr/uploads/2019/11/2847281231.png" alt="android-red-eio-screen.png"></p>
<p>Android系统有效？eio dm-verity mode是啥？</p>
<p>先不看code，我们继续看官方相关文档说明：</p>
<blockquote>
<p>Verified boot requires cryptographically verifying all executable code and data that is part of the Android version being booted before it is used. This includes the kernel (loaded from the boot partition), the device tree (loaded from the dtbo partition), system partition, vendor partition, and so on.</p>
<p>Small partitions, such as boot and dtbo, that are read only once are typically verified by loading the entire contents into memory and then calculating its hash. This calculated hash value is then compared to the expected hash value. If the value doesn’t match, Android won’t load. For more details, see Boot Flow.</p>
<p>Larger partitions that won’t fit into memory (such as, file systems) may use a hash tree where verification is a continuous process happening as data is loaded into memory. In this case, the root hash of the hash tree is calculated during run time and is checked against the expected root hash value. Android includes the dm-verity driver to verify larger partitions. If at some point the calculated root hash doesn’t match the expected root hash value, the data is not used and Android enters an error state. For more details, see dm-verity corruption.</p>
</blockquote>
<p>就是说avb会校验数据，小分区boot，dtbo会全部加载到memory去计算hash。大分区如system是用内核的dm-verity来完成。如果有错，会进入一个错误状态，详见dm-verity corruption。这里官方有个link会转到上面提到的RED eio screen。</p>
<p>啥子？system数据有问题？avbtool等check了下么问题啊，怎么check后面再写篇哈。</p>
<p>这可是官网说明啊。我们回看上次的root cause log:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">avb_slot_verify.c:657: ERROR: vbmeta_system_a: Image rollback index is less than the stored rollback index.</span><br></pre></td></tr></table></figure>

<p>uefi下的：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AVB_SLOT_VERIFY_RESULT_ERROR_ROLLBACK_INDEX</span><br></pre></td></tr></table></figure>

<p>我们再看下code:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Return codes used in avb_slot_verify(), see that function for</span></span><br><span class="line"><span class="comment"> * documentation for each field.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Use avb_slot_verify_result_to_string() to get a textual</span></span><br><span class="line"><span class="comment"> * representation usable for error/debug output.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_OK,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_OOM,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_IO,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_VERIFICATION,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_ROLLBACK_INDEX,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_PUBLIC_KEY_REJECTED,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_METADATA,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_UNSUPPORTED_VERSION,</span><br><span class="line">  AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_ARGUMENT</span><br><span class="line">&#125; AvbSlotVerifyResult;</span><br></pre></td></tr></table></figure>

<p>对每个field的解释，注释写的很清楚了，不用grep了，直接看<code>avb_slot_verify_result_to_string</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span>* <span class="title function_">avb_slot_verify_result_to_string</span><span class="params">(AvbSlotVerifyResult result)</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* ret = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_OK:</span><br><span class="line">      ret = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_OOM:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_OOM&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_IO:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_IO&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_VERIFICATION:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_VERIFICATION&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_ROLLBACK_INDEX:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_ROLLBACK_INDEX&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_PUBLIC_KEY_REJECTED:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_PUBLIC_KEY_REJECTED&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_METADATA:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_INVALID_METADATA&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_UNSUPPORTED_VERSION:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_UNSUPPORTED_VERSION&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AVB_SLOT_VERIFY_RESULT_ERROR_INVALID_ARGUMENT:</span><br><span class="line">      ret = <span class="string">&quot;ERROR_INVALID_ARGUMENT&quot;</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">/* Do not add a &#x27;default:&#x27; case here because of -Wswitch. */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    avb_error(<span class="string">&quot;Unknown AvbSlotVerifyResult value.\n&quot;</span>);</span><br><span class="line">    ret = <span class="string">&quot;(unknown)&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码看，dm-verity corruption应该是<code>AVB_SLOT_VERIFY_RESULT_ERROR_VERIFICATION</code>，而不是<code>AVB_SLOT_VERIFY_RESULT_ERROR_ROLLBACK_INDEX</code>。</p>
<p>相关code再show出来：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (vbmeta_header.rollback_index &lt; stored_rollback_index) &#123;</span><br><span class="line">  avb_errorv(</span><br><span class="line">      full_partition_name,</span><br><span class="line">      <span class="string">&quot;: Image rollback index is less than the stored rollback index.\n&quot;</span>,</span><br><span class="line">      <span class="literal">NULL</span>);</span><br><span class="line">  ret = AVB_SLOT_VERIFY_RESULT_ERROR_ROLLBACK_INDEX;</span><br><span class="line">  <span class="keyword">if</span> (!allow_verification_error) &#123;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>what is <code>rollback_index</code> and what is <code>stored_rollback_index</code> and why need to check the value in avb?</p>
<p>ok, let’s check Android doc since it’s belong to avb, avb doc must intro:</p>
<p>一看果然有，叫<em>rollback protection</em>，姑且译成回滚保护：</p>
<blockquote>
<p>Rollback protection</p>
<p>Even with a completely secure update process, it’s possible for a non-persistent Android kernel exploit to manually install an older, more vulnerable version of Android, reboot into the vulnerable version, and then use that Android version to install a persistent exploit. From there the attacker permanently owns the device and can do anything, including disabling updates.</p>
<p>The protection against this class of attacks is called Rollback Protection. Rollback protection is typically implemented by using tamper-evident storage to record the most recent version of the Android and refusing to boot Android if it’s lower than the recorded version. Versions are typically tracked on a per-partition basis.</p>
<p>For more details on how AVB handles rollback protections, see the AVB README.</p>
</blockquote>
<p>奥。。。防止黑客攻击滴。。。好吧。注意提到用<code>tamper-evident storage</code>来记录最近的Android版本并且拒绝启动比这个版本低的。</p>
<p>ok，终于对上了，人家就这么设计的。</p>
<p>这个tamper-evident storage是啥意思呢？对eMMC设备而言，就是RPMB分区，也就是说这个rollback index如果放到RPMB里，就别想再降级用了，RPMB想破解，没那么容易？</p>
<p>另外，吐槽下google文档和qcom uefi code对不上！大大厂啊。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://source.android.com/security/verifiedboot/boot-flow">https://source.android.com/security/verifiedboot/boot-flow</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://source.android.com/security/verifiedboot/verified-boot">https://source.android.com/security/verifiedboot/verified-boot</a></p>
</li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>版权声明：</span>本站所有文章均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明原文链接！</p></div><br><div class="tags"><a href="/tags/avb"><i class="fa fa-tag">avb</i></a></div><div class="post-nav"><a class="pre" href="/analyze-an-issue-about-screen-freeze.html">定屏问题分析</a><a class="next" href="/analyze-issue-about-device-is-corrupt-then-goto-fastboot-after-flashing.html">安卓刷机后出现device is corrupt后进入fastboot问题分析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/kernel-cfi-failure-analysis.html">Kernel CFI failure实例分析</a></li><li class="post-list-item"><a class="post-list-link" href="/linux-kernel-drm-overview.html">Linux kernel DRM overview</a></li><li class="post-list-item"><a class="post-list-link" href="/upgrade-my-custom-build-server-amd-based.html">我的PC组装升级记</a></li><li class="post-list-item"><a class="post-list-link" href="/convert-typecho-to-hexo.html">I am back!</a></li><li class="post-list-item"><a class="post-list-link" href="/review-freezing-issue-when-drag-icon-after-ohos-adaption.html">OpenHarmony适配后图标拖拽卡屏问题回顾</a></li><li class="post-list-item"><a class="post-list-link" href="/how-to-fix-parse-too-complex-in-source-insight.html">Source Insight 自定义解析</a></li><li class="post-list-item"><a class="post-list-link" href="/adapt-ohos-for-mali-g57-on-sprd-t606.html">转：拥抱鸿蒙 - 在展讯T606平台上的探索与实践</a></li><li class="post-list-item"><a class="post-list-link" href="/essential-inventory-of-adaption-for-unisoc-platform-androidt-based.html">展讯平台 OpenHarmony 3.2.2 适配基础盘点</a></li><li class="post-list-item"><a class="post-list-link" href="/porting-openharmony-linux-kernel-to-3rd-party-chip.html">快速移植 OpenHarmony Linux 内核到三方 ARM64 平台</a></li><li class="post-list-item"><a class="post-list-link" href="/openharmony-linux-kernel-overview.html">初识 OpenHarmony Linux Kernel</a></li></ul></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/arm/">arm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/dd/">dd</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ebpf/">ebpf</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/fs/">fs</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iot/">iot</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kernel/">kernel</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mm/">mm</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/msm/">msm</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ohos/">ohos</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/perf/">perf</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/security/">security</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/stab/">stab</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">20</span></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">TJ的技术博客.</a></div></div></div><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>